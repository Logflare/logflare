alias Logflare.Mapper
alias Logflare.Mapper.MappingConfig
alias Logflare.Mapper.MappingConfig.FieldConfig, as: Field

# Real-world edge log payload (POST 404) with deeply nested metadata.
# Source: Supabase edge function log via Cloudflare worker.
payload = %{
  "event_message" =>
    "POST | 404 | 33.254.251.15 | 9ee9a1c5fdfa3b4b | https://zzzenjkohrkaatgpywnz.supabase.co/rest/v1/rpc/set_active_session | Deno/2.1.4 (variant; SupabaseEdgeRuntime/1.69.25)",
  "headers" => %{
    "cf_cache_status" => "DYNAMIC",
    "cf_ray" => "99f7a1c7c2c33c4e-BOM",
    "content_type" => "application/json; charset=utf-8",
    "date" => "Thu, 15 Jan 2026 17:14:00 GMT",
    "sb_gateway_version" => "1",
    "sb_request_id" => "9f8bc2a6-57c0-7460-d3ad-9cebebcde78e",
    "transfer_encoding" => "chunked"
  },
  "id" => "65a8a593-ba4c-43ef-999f-6aa46a8d46d8",
  "identifier" => "zzzenjkohrkaatgpywnz",
  "logflare_worker" => %{
    "worker_id" => "ENUD7E"
  },
  "metadata" => %{
    "logflare_worker" => %{
      "worker_id" => "ENUD7E"
    },
    "request" => %{
      "cf" => %{
        "asOrganization" => "Amazon Technologies Inc.",
        "asn" => 16_509,
        "botManagement" => %{
          "corporateProxy" => false,
          "ja3Hash" => "8a64967e35f306b9a5f5cfe592dd153e",
          "ja4" => "t93e1011h2_61c7ad8aa9b6_3fcd1a44f789",
          "ja4Signals" => %{
            "browser_ratio_1h" => 0.0026498660445213,
            "cache_ratio_1h" => 0.038907047361135,
            "h2h3_ratio_1h" => 0.98994463682175,
            "heuristic_ratio_1h" => 0.22291173040867,
            "ips_quantile_1h" => 0.99974054098129,
            "ips_rank_1h" => 218,
            "paths_rank_1h" => 16,
            "reqs_quantile_1h" => 0.99995714426041,
            "reqs_rank_1h" => 36,
            "uas_rank_1h" => 294
          },
          "jsDetection" => %{
            "passed" => false
          },
          "score" => 22,
          "staticResource" => false,
          "verifiedBot" => false
        },
        "city" => "Mumbai",
        "clientAcceptEncoding" => "gzip, br",
        "clientTcpRtt" => 1,
        "clientTrustScore" => 22,
        "colo" => "BOM",
        "continent" => "AS",
        "country" => "IN",
        "edgeRequestKeepAliveStatus" => 1,
        "httpProtocol" => "HTTP/2",
        "latitude" => "19.07287",
        "longitude" => "72.88262",
        "postalCode" => "400017",
        "region" => "Maharashtra",
        "regionCode" => "MH",
        "requestPriority" => "weight=16;exclusive=0;group=0;group-weight=0",
        "timezone" => "Asia/Kolkata",
        "tlsCipher" => "AEAD-AES256-GCM-SHA384",
        "tlsClientAuth" => %{
          "certPresented" => "0",
          "certRevoked" => "0",
          "certVerified" => "NONE"
        },
        "tlsClientCiphersSha1" => "WUS3+h7TjVkF8aEouGuCEMjGQHA=",
        "tlsClientExtensionsSha1" => "ROAd8XY7DPwmmnYhpORdf3M19NE=",
        "tlsClientExtensionsSha1Le" => "WANJZpsaEjTvZbhntqQLKduIDgf=",
        "tlsClientHelloLength" => "268",
        "tlsClientRandom" => "ZZ7YaL2fEWTxlUuXPNzXYkjjp7xMySrWXFZWn6Yz1XZ=",
        "tlsExportedAuthenticator" => %{
          "clientFinished" =>
            "7cb587db93afce5a67bfa942c54853c46b2d57f0f66b3603a6d9b8429da18ad8c4a4a54cd15d6bf1fd42e59139d62d62",
          "clientHandshake" =>
            "8bbc12bca6736ce3eb7aa06e6cb06e3e1532cd84de5792473b9dc53a092d01694569c7902917f63dd69f68a064d9ed32",
          "serverFinished" =>
            "cb1f0f4aa08f5667013cda52f8d25e82fb3e19dbefa321668789aef9c0955e731343258ebc6461b8db9649b85d9271c4",
          "serverHandshake" =>
            "cb3bb2098387dd795c33357f0d63c45a85cce502dfa3d1a4cba8e249e8f1313f85dedf40b8e126d2ec58984fd3d7da5d"
        },
        "tlsVersion" => "TLSv1.3"
      },
      "headers" => %{
        "accept" => "*/*",
        "cf_connecting_ip" => "33.254.251.15",
        "cf_ipcountry" => "IN",
        "cf_ray" => "9ee9a1c5fdfa3b4b",
        "content_length" => "158",
        "content_type" => "application/json",
        "host" => "zzzenjkohrkaatgpywnz.supabase.co",
        "user_agent" => "Deno/2.1.4 (variant; SupabaseEdgeRuntime/1.69.25)",
        "x_client_info" => "supabase-js/2.20.0",
        "x_forwarded_proto" => "https",
        "x_real_ip" => "33.254.251.15"
      },
      "host" => "zzzenjkohrkaatgpywnz.supabase.co",
      "method" => "POST",
      "path" => "/rest/v1/rpc/set_active_session",
      "protocol" => "https:",
      "sb" => %{
        "jwt" => %{
          "apikey" => %{
            "payload" => %{
              "algorithm" => "HS256",
              "expires_at" => 2_062_373_547,
              "issuer" => "supabase",
              "role" => "service_role",
              "signature_prefix" => "grnZE8"
            }
          },
          "authorization" => %{
            "payload" => %{
              "algorithm" => "HS256",
              "expires_at" => 2_062_373_547,
              "issuer" => "supabase",
              "role" => "service_role",
              "signature_prefix" => "grnZE8"
            }
          }
        }
      },
      "url" => "https://zzzenjkohrkaatgpywnz.supabase.co/rest/v1/rpc/set_active_session"
    },
    "response" => %{
      "headers" => %{
        "cf_cache_status" => "DYNAMIC",
        "cf_ray" => "99f7a1c7c2c33c4e-BOM",
        "content_type" => "application/json; charset=utf-8",
        "date" => "Thu, 15 Jan 2026 17:14:00 GMT",
        "sb_gateway_version" => "1",
        "sb_request_id" => "9f8bc2a6-57c0-7460-d3ad-9cebebcde78e",
        "transfer_encoding" => "chunked"
      },
      "origin_time" => 367,
      "status_code" => 404
    }
  },
  "origin_time" => 367,
  "project" => "zzzenjkohrkaatgpywnz",
  "request" => %{
    "cf" => %{
      "asOrganization" => "Amazon Technologies Inc.",
      "asn" => 16_509,
      "botManagement" => %{
        "corporateProxy" => false,
        "ja3Hash" => "8a64967e35f306b9a5f5cfe592dd153e",
        "ja4" => "t93e1011h2_61c7ad8aa9b6_3fcd1a44f789",
        "ja4Signals" => %{
          "browser_ratio_1h" => 0.0026498660445213,
          "cache_ratio_1h" => 0.038907047361135,
          "h2h3_ratio_1h" => 0.98994463682175,
          "heuristic_ratio_1h" => 0.22291173040867,
          "ips_quantile_1h" => 0.99974054098129,
          "ips_rank_1h" => 218,
          "paths_rank_1h" => 16,
          "reqs_quantile_1h" => 0.99995714426041,
          "reqs_rank_1h" => 36,
          "uas_rank_1h" => 294
        },
        "jsDetection" => %{
          "passed" => false
        },
        "score" => 22,
        "staticResource" => false,
        "verifiedBot" => false
      },
      "city" => "Mumbai",
      "clientAcceptEncoding" => "gzip, br",
      "clientTcpRtt" => 1,
      "clientTrustScore" => 22,
      "colo" => "BOM",
      "continent" => "AS",
      "country" => "IN",
      "edgeRequestKeepAliveStatus" => 1,
      "httpProtocol" => "HTTP/2",
      "latitude" => "19.07283",
      "longitude" => "72.88261",
      "postalCode" => "400017",
      "region" => "Maharashtra",
      "regionCode" => "MH",
      "requestPriority" => "weight=16;exclusive=0;group=0;group-weight=0",
      "timezone" => "Asia/Kolkata",
      "tlsCipher" => "AEAD-AES256-GCM-SHA384",
      "tlsClientAuth" => %{
        "certPresented" => "0",
        "certRevoked" => "0",
        "certVerified" => "NONE"
      },
      "tlsClientCiphersSha1" => "WUS3+h7TjVkF8aEouGuCEMjGQHA=",
      "tlsClientExtensionsSha1" => "ROAd8XY7DPwmmnYhpORdf3M19NE=",
      "tlsClientExtensionsSha1Le" => "WANJZpsaEjTvZbhntqQLKduIDgf=",
      "tlsClientHelloLength" => "268",
      "tlsClientRandom" => "ZZ7YaL2fEWTxlUuXPNzXYkjjp7xMySrWXFZWn6Yz1XZ=",
      "tlsExportedAuthenticator" => %{
        "clientFinished" =>
          "7cb587db93afce5a67bfa942c54853c46b2d57f0f66b3603a6d9b8429da18ad8c4a4a54cd15d6bf1fd42e59139d62d62",
        "clientHandshake" =>
          "8bbc12bca6736ce3eb7aa06e6cb06e3e1532cd84de5792473b9dc53a092d01694569c7902917f63dd69f68a064d9ed32",
        "serverFinished" =>
          "cb1f0f4aa08f5667013cda52f8d25e82fb3e19dbefa321668789aef9c0955e731343258ebc6461b8db9649b85d9271c4",
        "serverHandshake" =>
          "cb3bb2098387dd795c33357f0d63c45a85cce502dfa3d1a4cba8e249e8f1313f85dedf40b8e126d2ec58984fd3d7da5d"
      },
      "tlsVersion" => "TLSv1.3"
    },
    "headers" => %{
      "accept" => "*/*",
      "cf_connecting_ip" => "33.254.251.15",
      "cf_ipcountry" => "IN",
      "cf_ray" => "9ee9a1c5fdfa3b4b",
      "content_length" => "158",
      "content_type" => "application/json",
      "host" => "zzzenjkohrkaatgpywnz.supabase.co",
      "user_agent" => "Deno/2.1.4 (variant; SupabaseEdgeRuntime/1.69.25)",
      "x_client_info" => "supabase-js/2.20.0",
      "x_forwarded_proto" => "https",
      "x_real_ip" => "33.254.251.15"
    },
    "host" => "zzzenjkohrkaatgpywnz.supabase.co",
    "method" => "POST",
    "path" => "/rest/v1/rpc/set_active_session",
    "protocol" => "https:",
    "sb" => %{
      "jwt" => %{
        "apikey" => %{
          "payload" => %{
            "algorithm" => "HS256",
            "expires_at" => 2_062_373_547,
            "issuer" => "supabase",
            "role" => "service_role",
            "signature_prefix" => "grnZE8"
          }
        },
        "authorization" => %{
          "payload" => %{
            "algorithm" => "HS256",
            "expires_at" => 2_062_373_547,
            "issuer" => "supabase",
            "role" => "service_role",
            "signature_prefix" => "grnZE8"
          }
        }
      }
    },
    "url" => "https://zzzenjkohrkaatgpywnz.supabase.co/rest/v1/rpc/set_active_session"
  },
  "request_id" => "9f8bc2a6-57c0-7460-d3ad-9cebebcde78e",
  "response" => %{
    "headers" => %{
      "cf_cache_status" => "DYNAMIC",
      "cf_ray" => "99f7a1c7c2c33c4e-BOM",
      "content_type" => "application/json; charset=utf-8",
      "date" => "Thu, 15 Jan 2026 17:14:00 GMT",
      "sb_gateway_version" => "1",
      "sb_request_id" => "9f8bc2a6-57c0-7460-d3ad-9cebebcde78e",
      "transfer_encoding" => "chunked"
    },
    "origin_time" => 367,
    "status_code" => 404
  },
  "source" => "985df630-a551-4c79-ff27-042650b37c62",
  "status_code" => 404,
  "timestamp" => 1_768_497_240_000_000
}

# Mapping config aligned with the OTEL logs table DDL
logs_mapping =
  MappingConfig.new([
    Field.string("project",
      paths: ["$.project", "$.project_ref", "$.project_id"],
      default: ""
    ),
    Field.string("trace_id",
      paths: ["$.trace_id", "$.traceId", "$.otel_trace_id"],
      default: ""
    ),
    Field.string("span_id",
      paths: ["$.span_id", "$.spanId", "$.otel_span_id"],
      default: ""
    ),
    Field.uint8("trace_flags",
      paths: ["$.trace_flags", "$.traceFlags"],
      default: 0
    ),
    Field.string("severity_text",
      paths: ["$.severity_text", "$.severityText", "$.metadata.level", "$.level"],
      default: "INFO",
      transform: "upcase"
    ),
    Field.uint8("severity_number",
      from_output: "severity_text",
      value_map: %{
        "TRACE" => 1,
        "DEBUG" => 5,
        "INFO" => 9,
        "WARN" => 13,
        "WARNING" => 13,
        "ERROR" => 17,
        "FATAL" => 21,
        "CRITICAL" => 21,
        "EMERGENCY" => 21
      },
      default: 0
    ),
    Field.string("service_name",
      paths: [
        "$.resource.service.name",
        "$.service_name",
        "$.resource.name",
        "$.metadata.context.application"
      ],
      default: ""
    ),
    Field.string("event_message",
      paths: ["$.event_message", "$.message", "$.body", "$.msg"],
      default: ""
    ),
    Field.string("scope_name",
      paths: [
        "$.scope.name",
        "$.metadata.context.module",
        "$.metadata.context.application",
        "$.instrumentation_library.name"
      ],
      default: ""
    ),
    Field.string("scope_version",
      paths: [
        "$.scope.version",
        "$.instrumentation_library.version"
      ],
      default: ""
    ),
    Field.string("scope_schema_url",
      paths: ["$.scope.schema_url"],
      default: ""
    ),
    Field.string("resource_schema_url",
      paths: ["$.resource.schema_url"],
      default: ""
    ),
    Field.json("resource_attributes",
      paths: ["$.resource"],
      pick: [
        {"region", ["$.metadata.region", "$.region"]},
        {"cluster", ["$.metadata.cluster", "$.cluster"]},
        {"service.name", ["$.resource.service.name", "$.service_name"]},
        {"application", ["$.metadata.context.application"]},
        {"node", ["$.metadata.context.vm.node"]},
        {"project", ["$.project", "$.project_ref", "$.project_id"]}
      ],
      default: %{}
    ),
    Field.json("scope_attributes",
      paths: ["$.scope.attributes", "$.scope"],
      default: %{}
    ),
    Field.json("log_attributes",
      path: "$",
      exclude_keys: ["id", "event_message", "timestamp"],
      elevate_keys: ["metadata"]
    ),
    Field.datetime64("timestamp", path: "$.timestamp", precision: 9)
  ])

# Manual mapping function matching the same coalesce logic
manual_map = fn doc ->
  severity_text =
    (doc["severity_text"] || doc["severityText"] ||
       get_in(doc, ["metadata", "level"]) || doc["level"] || "INFO")
    |> String.upcase()

  severity_value_map = %{
    "TRACE" => 1,
    "DEBUG" => 5,
    "INFO" => 9,
    "WARN" => 13,
    "WARNING" => 13,
    "ERROR" => 17,
    "FATAL" => 21,
    "CRITICAL" => 21,
    "EMERGENCY" => 21
  }

  pick_results =
    [
      {"region", [get_in(doc, ["metadata", "region"]), doc["region"]]},
      {"cluster", [get_in(doc, ["metadata", "cluster"]), doc["cluster"]]},
      {"service.name", [get_in(doc, ["resource", "service", "name"]), doc["service_name"]]},
      {"application", [get_in(doc, ["metadata", "context", "application"])]},
      {"node", [get_in(doc, ["metadata", "context", "vm", "node"])]},
      {"project", [doc["project"], doc["project_ref"], doc["project_id"]]}
    ]
    |> Enum.reduce(%{}, fn {key, vals}, acc ->
      case Enum.find(vals, &(&1 != nil)) do
        nil -> acc
        val -> Map.put(acc, key, val)
      end
    end)

  resource_attributes =
    if map_size(pick_results) > 0,
      do: pick_results,
      else: doc["resource"] || %{}

  log_attributes =
    doc
    |> Map.drop(["id", "event_message", "timestamp"])
    |> then(fn m ->
      case Map.pop(m, "metadata") do
        {nil, m} -> m
        {metadata, m} -> Map.merge(metadata, m)
      end
    end)

  %{
    "project" => doc["project"] || doc["project_ref"] || doc["project_id"] || "",
    "trace_id" => doc["trace_id"] || doc["traceId"] || doc["otel_trace_id"] || "",
    "span_id" => doc["span_id"] || doc["spanId"] || doc["otel_span_id"] || "",
    "trace_flags" => doc["trace_flags"] || doc["traceFlags"] || 0,
    "severity_text" => severity_text,
    "severity_number" => Map.get(severity_value_map, severity_text, 0),
    "service_name" =>
      get_in(doc, ["resource", "service", "name"]) ||
        doc["service_name"] ||
        get_in(doc, ["resource", "name"]) ||
        get_in(doc, ["metadata", "context", "application"]) ||
        "",
    "event_message" => doc["event_message"] || doc["message"] || doc["body"] || doc["msg"] || "",
    "scope_name" =>
      get_in(doc, ["scope", "name"]) ||
        get_in(doc, ["metadata", "context", "module"]) ||
        get_in(doc, ["metadata", "context", "application"]) ||
        get_in(doc, ["instrumentation_library", "name"]) ||
        "",
    "scope_version" =>
      get_in(doc, ["scope", "version"]) ||
        get_in(doc, ["instrumentation_library", "version"]) ||
        "",
    "scope_schema_url" => get_in(doc, ["scope", "schema_url"]) || "",
    "resource_schema_url" => get_in(doc, ["resource", "schema_url"]) || "",
    "resource_attributes" => resource_attributes,
    "scope_attributes" => get_in(doc, ["scope", "attributes"]) || doc["scope"] || %{},
    "log_attributes" => log_attributes,
    "timestamp" => doc["timestamp"]
  }
end

# Hybrid config: NIF handles everything except log_attributes JSON ops
hybrid_mapping =
  MappingConfig.new([
    Field.string("project",
      paths: ["$.project", "$.project_ref", "$.project_id"],
      default: ""
    ),
    Field.string("trace_id",
      paths: ["$.trace_id", "$.traceId", "$.otel_trace_id"],
      default: ""
    ),
    Field.string("span_id",
      paths: ["$.span_id", "$.spanId", "$.otel_span_id"],
      default: ""
    ),
    Field.uint8("trace_flags",
      paths: ["$.trace_flags", "$.traceFlags"],
      default: 0
    ),
    Field.string("severity_text",
      paths: ["$.severity_text", "$.severityText", "$.metadata.level", "$.level"],
      default: "INFO",
      transform: "upcase"
    ),
    Field.uint8("severity_number",
      from_output: "severity_text",
      value_map: %{
        "TRACE" => 1,
        "DEBUG" => 5,
        "INFO" => 9,
        "WARN" => 13,
        "WARNING" => 13,
        "ERROR" => 17,
        "FATAL" => 21,
        "CRITICAL" => 21,
        "EMERGENCY" => 21
      },
      default: 0
    ),
    Field.string("service_name",
      paths: [
        "$.resource.service.name",
        "$.service_name",
        "$.resource.name",
        "$.metadata.context.application"
      ],
      default: ""
    ),
    Field.string("event_message",
      paths: ["$.event_message", "$.message", "$.body", "$.msg"],
      default: ""
    ),
    Field.string("scope_name",
      paths: [
        "$.scope.name",
        "$.metadata.context.module",
        "$.metadata.context.application",
        "$.instrumentation_library.name"
      ],
      default: ""
    ),
    Field.string("scope_version",
      paths: [
        "$.scope.version",
        "$.instrumentation_library.version"
      ],
      default: ""
    ),
    Field.string("scope_schema_url",
      paths: ["$.scope.schema_url"],
      default: ""
    ),
    Field.string("resource_schema_url",
      paths: ["$.resource.schema_url"],
      default: ""
    ),
    Field.json("resource_attributes",
      paths: ["$.resource"],
      pick: [
        {"region", ["$.metadata.region", "$.region"]},
        {"cluster", ["$.metadata.cluster", "$.cluster"]},
        {"service.name", ["$.resource.service.name", "$.service_name"]},
        {"application", ["$.metadata.context.application"]},
        {"node", ["$.metadata.context.vm.node"]},
        {"project", ["$.project", "$.project_ref", "$.project_id"]}
      ],
      default: %{}
    ),
    Field.json("scope_attributes",
      paths: ["$.scope.attributes", "$.scope"],
      default: %{}
    ),
    Field.datetime64("timestamp", path: "$.timestamp", precision: 9)
  ])

compiled = Mapper.compile!(logs_mapping)
compiled_hybrid = Mapper.compile!(hybrid_mapping)

# Elixir-side log_attributes: drop 3 keys, elevate metadata
build_log_attributes = fn doc ->
  doc
  |> Map.drop(["id", "event_message", "timestamp"])
  |> then(fn m ->
    case Map.pop(m, "metadata") do
      {nil, m} -> m
      {metadata, m} when is_map(metadata) -> Map.merge(metadata, m)
      {_, m} -> m
    end
  end)
end

nif_result = Mapper.map(payload, compiled)
manual_result = manual_map.(payload)

hybrid_result =
  payload
  |> Mapper.map(compiled_hybrid)
  |> Map.put("log_attributes", build_log_attributes.(payload))

# credo:disable-for-lines:4
IO.puts("\n--- NIF output keys: #{inspect(Map.keys(nif_result) |> Enum.sort())}")
IO.puts("--- Manual output keys: #{inspect(Map.keys(manual_result) |> Enum.sort())}")
IO.puts("--- Hybrid output keys: #{inspect(Map.keys(hybrid_result) |> Enum.sort())}")
IO.puts("")

Benchee.run(
  %{
    "NIF mapper (pre-compiled)" => fn -> Mapper.map(payload, compiled) end,
    "NIF hybrid (NIF + Elixir log_attrs)" => fn ->
      payload
      |> Mapper.map(compiled_hybrid)
      |> Map.put("log_attributes", build_log_attributes.(payload))
    end,
    "Manual Elixir map" => fn -> manual_map.(payload) end
  },
  time: 5,
  warmup: 2,
  memory_time: 3,
  reduction_time: 3
)
